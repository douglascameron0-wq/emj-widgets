<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EMJ Businesses</title>
<style>
  :root {
    --card-border:#e2e8f0; --ink:#0f172a; --muted:#64748b; --ink-2:#475569;
    --chip-bg:#f1f5f9; --accent:#ff7f50; --shadow:0 4px 12px rgba(0,0,0,.08);
  }
  html,body{margin:0;padding:0;background:transparent;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);}
  .wrap{padding:0 0 4px;}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));}
  .card{
    background:#fff;border:1px solid var(--card-border);border-left:4px solid var(--accent);
    border-radius:10px;padding:10px 12px;box-shadow:var(--shadow);
  }
  .head{display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .title{margin:0;font-size:1rem;line-height:1.2;}
  .title a{color:var(--ink);text-decoration:none;font-weight:700;}
  .title a:hover{color:var(--accent);}
  .badge{background:var(--accent);color:#fff;font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:999px;white-space:nowrap;}
  .meta{color:var(--muted);font-size:.82rem;margin:.25rem 0 0;}
  .desc{margin:.5rem 0 0;color:var(--ink-2);font-size:.9rem;line-height:1.35;}
  .chip{display:inline-block;background:#f1f5f9;color:#334155;border:1px solid var(--card-border);
        font-size:.72rem;padding:2px 6px;border-radius:999px;margin-top:6px;}
  .links{margin-top:8px;}
  .btn{
    display:inline-block;margin-right:8px;padding:4px 10px;font-size:.85rem;
    background:#f1f5f9;border-radius:6px;text-decoration:none;color:var(--ink);
  }
  .btn:hover{background:#e2e8f0;}
  .status{color:#334155;font-size:.9rem;padding:6px 2px;}
</style>
</head>
<body>
<div class="wrap">
  <div id="status" class="status">Loadingâ€¦</div>
  <div id="grid" class="grid" hidden></div>
</div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const SRC = params.get("src");

  function parseCSV(text){
    const rows=[]; let row=[], cell='', q=false;
    for(let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if(q){
        if(c=='"' && n=='"'){ cell+='"'; i++; }
        else if(c=='"'){ q=false; }
        else { cell+=c; }
      } else {
        if(c=='"'){ q=true; }
        else if(c==','){ row.push(cell); cell=''; }
        else if(c=='\n'){ row.push(cell); rows.push(row); row=[]; cell=''; }
        else if(c=='\r'){ }
        else { cell+=c; }
      }
    }
    if(cell.length || row.length){ row.push(cell); rows.push(row); }
    return rows;
  }
  const norm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

  async function go(){
    const status = document.getElementById('status');
    const grid = document.getElementById('grid');

    if(!SRC){ status.textContent = "Missing ?src=CSV_URL"; ping(); return; }

    try{
      const res = await fetch(SRC, {cache:"no-store", referrerPolicy:"no-referrer"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();
      let rows = parseCSV(text);
      if(!rows.length) throw new Error("Empty CSV");
      if(rows[0] && rows[0][0]) rows[0][0] = rows[0][0].replace(/^\uFEFF/, "");

      const headers = rows.shift();
      const m = {}; headers.forEach((h,i)=> m[norm(h)] = i);

      const iName = m[norm("Name")];
      const iLoc  = m[norm("Location")];
      const iHrs  = m[norm("Hours")];
      const iWeb  = m[norm("Website")];
      const iFB   = m[norm("Facebook")];
      const iIG   = m[norm("Instagram")];
      const iCat  = m[norm("Category")];
      const iDesc = m[norm("Description")];
      const iPh   = m[norm("Phone Number")];
      const iFeat = m[norm("Featured")] ?? m[norm("Featured (Yes/No)")];

      if(iName == null || iName < 0) throw new Error("Missing 'Name' column");

      let data = rows
        .filter(r => r && r.length && r[iName] && r[iName].trim().length)
        .map(r => ({
          name:(r[iName]||"").trim(),
          loc:(r[iLoc]||"").trim(),
          hrs:(r[iHrs]||"").trim(),
          web:(r[iWeb]||"").trim(),
          fb:(r[iFB]||"").trim(),
          ig:(r[iIG]||"").trim(),
          cat:(r[iCat]||"").trim(),
          desc:(r[iDesc]||"").trim(),
          ph:(r[iPh]||"").trim(),
          feat:(iFeat!=null && iFeat>=0) ? ((r[iFeat]||"").toLowerCase().trim()==="yes") : false
        }));

      data.sort((a,b)=>(b.feat===a.feat)?0:(b.feat?1:-1)).reverse();

      if(!data.length){ status.textContent = "No rows found."; ping(); return; }

      grid.innerHTML = data.map(b=>{
        const title = b.web ? `<a href="${b.web}" target="_blank" rel="noopener">${b.name}</a>` : b.name;
        const meta = [b.loc,b.hrs].filter(Boolean).join(" â€¢ ");
        const call = b.ph ? `<a href="tel:${b.ph.replace(/\D/g,'')}" class="btn">ðŸ“ž Call</a>` : "";
        const fb   = b.fb ? `<a href="${b.fb}" target="_blank" rel="noopener" class="btn">Facebook</a>` : "";
        const ig   = b.ig ? `<a href="${b.ig}" target="_blank" rel="noopener" class="btn">Instagram</a>` : "";
        const chip = b.cat ? `<span class="chip">${b.cat}</span>` : "";
        const badge= b.feat ? `<span class="badge">â˜… Featured</span>` : "";
        return `
          <div class="card">
            <div class="head">
              <h3 class="title">${title}</h3>
              ${badge}
            </div>
            ${meta ? `<div class="meta">${meta}</div>` : ``}
            ${b.desc ? `<p class="desc">${b.desc}</p>` : ``}
            ${chip}
            <div class="links">${call}${fb}${ig}</div>
          </div>
        `;
      }).join("");

      status.remove();
      grid.hidden = false;
      ping();
    } catch(err){
      const status = document.getElementById('status');
      status.textContent = "Error: " + err.message;
      ping();
    }
  }

  function ping(){
    const h = document.documentElement.scrollHeight || document.body.scrollHeight;
    parent.postMessage({ type:"emjH", h }, "*");
    setTimeout(()=> parent.postMessage({type:"emjH", h:document.documentElement.scrollHeight}, "*"), 200);
    setTimeout(()=> parent.postMessage({type:"emjH", h:document.documentElement.scrollHeight}, "*"), 800);
  }

  window.addEventListener("load", go);
})();
</script>
</body>
</html>