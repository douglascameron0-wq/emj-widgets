<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EMJ Highlights (CSV-Flex + Auto-resize)</title>
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --card:#ffffff; --border:#e2e8f0; --muted:#475569;
    --accent:#ff7f50; --gap:16px; --maxw:1100px; --radius:12px;
    --shadow:0 2px 6px rgba(2,6,23,.12); --shadow-hover:0 8px 24px rgba(2,6,23,.18);
    --pad:16px;
  }
  body{margin:0;background:#f5f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  section[aria-label="Moose Jaw Highlights"]{background:var(--bg); color:var(--ink); border-radius:14px; margin:18px; padding:12px;}
  .wrap{max-width:var(--maxw); margin:0 auto; padding:8px 10px 14px;}
  .title{font-weight:800; color:var(--accent); margin:8px 4px 10px; font-size:1.05rem;}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:var(--gap);}
  .card{position:relative; background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
        box-shadow:var(--shadow); overflow:hidden; transition:transform .18s ease, box-shadow .18s ease;}
  .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
  .card a.cardlink{ position:absolute; inset:0; z-index:1; border-radius:inherit; }
  .pad{ padding:var(--pad); position:relative; z-index:2; }
  .h{ font-size:0.98rem; font-weight:800; color:var(--accent); margin:0 0 6px; }
  .desc{ font-size:0.9rem; color:var(--muted); margin:0; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .badge{ font-size:.72rem; border:1px dashed var(--border); color:#64748b; padding:4px 8px; border-radius:999px; }
  #emj-debug{margin-top:8px;font-size:.85rem;color:#94a3b8;white-space:pre-wrap}
  @media (max-width:640px){ :root{ --gap:14px; } .wrap{ padding:8px 8px 14px;} }
</style>
</head>
<body>
<section aria-label="Moose Jaw Highlights">
  <div class="wrap">
    <div class="title">Moose Jaw Highlights</div>
    <div class="grid" id="emj-grid"></div>
    <div id="emj-debug"></div>
  </div>
</section>

<script>
  // ---- Params & theming ----
  (function applyParams(){
    const q = new URLSearchParams(location.search);
    const gap = q.get('gap'); const maxw = q.get('maxw');
    const root = document.documentElement;
    if(gap) root.style.setProperty('--gap', parseInt(gap,10)+'px');
    if(maxw) root.style.setProperty('--maxw', /px$|%$/.test(maxw)?maxw: (parseInt(maxw,10)+'px'));
  })();

  const CSV_URL_DEFAULT = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0N9M2sACtG-R3_j6SQoZQkxgrjWDHWYVAVrL7mKaXliu_SxrMOwcg8giDTX5l-4zO1k2H2B2Btxsd/pub?gid=1511064584&single=true&output=csv';
  const params = new URLSearchParams(location.search);
  const CSV_URL = params.get('csv') || CSV_URL_DEFAULT;

  // Optional header overrides via URL:
  // ?headers=title=Event%20Name,desc=Details,image=Photo,primary_url=Link,primary_text=Button
  function parseHeaderOverrides(s){
    const map = {};
    if(!s) return map;
    s.split(',').forEach(pair=>{
      const [k,v] = pair.split('=');
      if(k && v) map[k.trim().toLowerCase()] = v.trim().toLowerCase();
    });
    return map;
  }
  const headerOverride = parseHeaderOverrides(params.get('headers'));

  // ---- CSV parsing (with quotes) ----
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(!lines.length) return {headers:[], rows:[]};
    const raw = lines.shift();
    const headers = raw.split(',').map(h=>h.trim().toLowerCase());
    const rows = lines.map(line=>{
      const vals=[]; let cur='', q=false;
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='\"'){ if(q && line[i+1]==='\"'){cur+='\"'; i++;} else q=!q; }
        else if(c===',' && !q){ vals.push(cur); cur=''; }
        else { cur+=c; }
      }
      vals.push(cur);
      const obj={};
      headers.forEach((h,i)=> obj[h]=(vals[i]||'').trim());
      return obj;
    });
    return {headers, rows};
  }

  const esc = s => (s||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  const vis = v => { const s=(v||'').toLowerCase(); return !s || ['yes','y','true','1'].includes(s); };
  const badge = t => `<span class="badge">${esc(t)}</span>`;

  // ---- Flexible header picking ----
  const ALIASES = {
    title: ['title','name','event','heading'],
    desc: ['desc','description','details','summary','subtitle','subheading','blurb'],
    image: ['image','img','photo','picture','cover','thumb'],
    ribbon: ['ribbon','label','tagline','flag'],
    date: ['date','when','kicker'],
    tags: ['tags','labels','chips','badges'],
    primary_text: ['primary_text','button','cta','cta_text','link_text','action','primarylabel','primary'],
    primary_url: ['primary_url','url','link','href','cta_url','button_url','primarylink'],
    secondary_text: ['secondary_text','secondary','secondarylabel','alt_button','secondarycta','secondary_link_text'],
    secondary_url: ['secondary_url','secondary_link','alt_url','secondaryhref','secondarylink'],
    weight: ['weight','order','rank','prio','priority','sort'],
    visible: ['visible','show','published','active','enabled']
  };

  // Build a lookup map from actual headers
  function buildHeaderMap(actualHeaders){
    const map = {};
    // Apply explicit URL overrides first
    for(const k in headerOverride){
      map[k] = headerOverride[k];
    }
    // Then infer by aliases
    for(const key in ALIASES){
      if(map[key]) continue;
      const options = ALIASES[key];
      const found = actualHeaders.find(h => options.includes(h));
      if(found) map[key] = found;
    }
    return map;
  }

  function pick(row, map, key){
    const h = map[key];
    return (h && row[h] != null) ? row[h] : '';
  }

  function cardHTML(row, map){
    const v = (pick(row,map,'visible') || '').toLowerCase();
    if(v && !['yes','y','true','1'].includes(v)) return '';
    const title = pick(row,map,'title') || 'Untitled';
    const desc = pick(row,map,'desc') || '';
    const primaryURL = pick(row,map,'primary_url');
    const primaryText = pick(row,map,'primary_text') || 'More Info';
    const tagsRaw = pick(row,map,'tags');
    const tags = (tagsRaw||'').split(/\||,/).filter(Boolean).map(badge).join('');
    const link = primaryURL ? `<a class="cardlink" href="${esc(primaryURL)}" target="_blank" rel="noopener"></a>` : '';
    return `
      <article class="card">
        ${link}
        <div class="pad">
          <h3 class="h">${esc(title)}</h3>
          <p class="desc">${esc(desc)}</p>
          ${tags?`<div class="meta">${tags}</div>`:''}
        </div>
      </article>`;
  }

  function render(headers, rows){
    const map = buildHeaderMap(headers);
    // sort by weight if present
    const sorted = rows.slice().sort((a,b)=> (parseInt(pick(b,map,'weight'))||0) - (parseInt(pick(a,map,'weight'))||0));
    const html = sorted.map(r=>cardHTML(r,map)).filter(Boolean).join('');
    const grid = document.getElementById('emj-grid');
    grid.innerHTML = html || '<div style="color:#94a3b8;">No highlights available.</div>';

    // Debug block (first load only)
    const dbg = document.getElementById('emj-debug');
    if(dbg && !dbg.dataset.done){
      dbg.dataset.done = '1';
      dbg.textContent = 'Detected headers: ' + headers.join(', ') + '\n' +
                        'Mapping used: ' + JSON.stringify(map, null, 2) + '\n' +
                        'Tip: override via ?headers=title=Your%20Title,desc=Your%20Desc,primary_url=Your%20Link';
    }
    postHeight();
  }

  function postHeight(){
    const h = document.documentElement.scrollHeight;
    parent.postMessage({ type:'resize', height:h }, '*');
  }

  fetch(CSV_URL)
    .then(r=>r.text())
    .then(txt=>{
      const {headers, rows} = parseCSV(txt);
      render(headers, rows);
    })
    .catch(err=>{
      document.getElementById('emj-debug').textContent = 'Could not load CSV: '+err;
      postHeight();
    });

  const ro = new ResizeObserver(postHeight);
  ro.observe(document.body);
  setInterval(postHeight, 1000);
</script>
</body>
</html>
