<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EMJ Highlights (CSV + Auto-resize)</title>
<style>
  :root{
    --bg:#0f172a; --ink:#f8fafc; --card:#ffffff; --border:#e2e8f0; --muted:#475569;
    --accent:#ff7f50; --gap:16px; --maxw:1100px; --radius:12px;
    --shadow:0 2px 6px rgba(2,6,23,.12); --shadow-hover:0 8px 24px rgba(2,6,23,.18);
    --pad:16px;
  }
  body{margin:0;background:#f5f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  section[aria-label="Moose Jaw Highlights"]{background:var(--bg); color:var(--ink); border-radius:14px; margin:18px; padding:12px;}
  .wrap{max-width:var(--maxw); margin:0 auto; padding:8px 10px 14px;}
  .title{font-weight:800; color:var(--accent); margin:8px 4px 10px; font-size:1.05rem;}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:var(--gap);}
  .card{position:relative; background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
        box-shadow:var(--shadow); overflow:hidden; transition:transform .18s ease, box-shadow .18s ease;}
  .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
  .card a.cardlink{ position:absolute; inset:0; z-index:1; border-radius:inherit; }
  .pad{ padding:var(--pad); position:relative; z-index:2; }
  .h{ font-size:0.98rem; font-weight:800; color:var(--accent); margin:0 0 6px; }
  .desc{ font-size:0.9rem; color:var(--muted); margin:0; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .badge{ font-size:.72rem; border:1px dashed var(--border); color:#64748b; padding:4px 8px; border-radius:999px; }
  @media (max-width:640px){ :root{ --gap:14px; } .wrap{ padding:8px 8px 14px;} }
</style>
</head>
<body>
<section aria-label="Moose Jaw Highlights">
  <div class="wrap">
    <div class="title">Moose Jaw Highlights</div>
    <div class="grid" id="emj-grid"></div>
    <div id="emj-debug" style="margin-top:8px; font-size:.85rem; color:#94a3b8;"></div>
  </div>
</section>

<script>
  // Allow ?csv=, ?gap=, ?maxw= overrides
  (function applyParams(){
    const q = new URLSearchParams(location.search);
    const gap = q.get('gap'); const maxw = q.get('maxw');
    const root = document.documentElement;
    if(gap) root.style.setProperty('--gap', parseInt(gap,10)+'px');
    if(maxw) root.style.setProperty('--maxw', /px$|%$/.test(maxw)?maxw: (parseInt(maxw,10)+'px'));
  })();

  const CSV_URL_DEFAULT = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0N9M2sACtG-R3_j6SQoZQkxgrjWDHWYVAVrL7mKaXliu_SxrMOwcg8giDTX5l-4zO1k2H2B2Btxsd/pub?gid=1511064584&single=true&output=csv';
  const CSV_URL = new URLSearchParams(location.search).get('csv') || CSV_URL_DEFAULT;

  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(!lines.length) return [];
    const headers = lines.shift().split(',').map(h=>h.trim().toLowerCase());
    return lines.map(line=>{
      const vals=[]; let cur='', q=false;
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='\"'){ if(q && line[i+1]==='\"'){cur+='\"'; i++;} else q=!q; }
        else if(c===',' && !q){ vals.push(cur); cur=''; }
        else { cur+=c; }
      }
      vals.push(cur);
      const o={}; headers.forEach((h,i)=> o[h]=(vals[i]||'').trim());
      return o;
    });
  }
  const esc = s => (s||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  const visible = v => { const s=(v||'').toLowerCase(); return !s || ['yes','y','true','1'].includes(s); };
  const badge = t => `<span class="badge">${esc(t)}</span>`;

  function cardHTML(it){
    if(!visible(it.visible||it.show||it.published)) return '';
    const primary = it.primary_url ? `<a class="cardlink" href="${esc(it.primary_url)}" target="_blank" rel="noopener"></a>` : '';
    const tags = (it.tags||'').split(/\||,/).filter(Boolean).map(badge).join('');
    return `
      <article class="card">
        ${primary}
        <div class="pad">
          <h3 class="h">${esc(it.title||'Untitled')}</h3>
          <p class="desc">${esc(it.desc||it.description||it.subtitle||'')}</p>
          ${tags?`<div class="meta">${tags}</div>`:''}
        </div>
      </article>`;
  }

  function render(rows){
    rows.sort((a,b)=> (parseInt(b.weight)||0) - (parseInt(a.weight)||0));
    const html = rows.map(cardHTML).filter(Boolean).join('');
    const grid = document.getElementById('emj-grid');
    grid.innerHTML = html || '<div style="color:#94a3b8;">No highlights available.</div>';
    postHeight();
  }

  // Auto-resize helpers
  function postHeight(){
    const h = document.documentElement.scrollHeight;
    parent.postMessage({ type:'resize', height:h }, '*');
  }

  // Fetch and render
  fetch(CSV_URL)
    .then(r=>r.text())
    .then(txt=>render(parseCSV(txt)))
    .catch(err=>{
      document.getElementById('emj-debug').textContent = 'Could not load CSV: '+err;
      postHeight();
    });

  // Update height on resize/mutation
  const ro = new ResizeObserver(postHeight);
  ro.observe(document.body);
  setInterval(postHeight, 1000);
</script>
</body>
</html>
